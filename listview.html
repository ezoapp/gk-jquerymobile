<element name='listview'>

  <template>
    <ul id="{{id}}" data-role="listview" style="{{style}}" data-repeat="{{data-repeat}}"
        data-init-blank="{{data-init-blank}}" data-autodividers="{{data-autodividers}}"
        data-divider-theme="{{data-divider-theme}}" data-filter-reveal="{{data-filter-reveal}}"
        data-filter="{{data-filter}}" data-filter-placeholder="{{data-filter-placeholder}}"
        data-filter-theme="{{data-filter-theme}}" data-icon="{{data-icon}}" data-inset="{{data-inset}}"
        data-split-icon="{{data-split-icon}}" data-split-theme="{{data-split-theme}}" data-theme="{{data-theme}}"
        data-count-theme="{{data-count-theme}}">
      <content></content>
    </ul>
  </template>

  <script>
    var utils = require('./js/utils');

    registerElement('listview', {
      init: function () {
        var self = this,
            $ele = self.$ele,
            $originEle = self.$originEle,
            tagName = $ele.prop('tagName').toLowerCase(),
            originTagName = $originEle.prop('tagName').toLowerCase();
        self.html = $ele.html().trim();
        self.templateHTML = $originEle.html().trim();
        self.repeat = $originEle.data('repeat');
        ($originEle.data('initBlank') !== false) && ($ele.html(''));
        
        if (originTagName !== tagName) {
          utils.changeTagNameOfGKElment(this, originTagName);
        }
      },

      refresh: function () {
        this.$ele.listview('refresh');
      },

      autodividersSelector: function (selector) {
        if ($.isFunction(selector)) {
          this.$ele.listview({
            autodividersSelector: selector
          });
          this.refresh();
        }
      },

      onRowEvent: function (event, handler) {
        var self = this;
        self.$ele.on(event, 'li:not([data-role="list-divider"])', function (eo) {
          dispatchEventToHandler(this, eo, handler, self);
        });
      },

      onRow: function (handler) {
        if ($.isFunction(handler)) {
          this.onRowEvent('click', handler);
        } 
      },
      
      onTapHold: function (handler) {
        if ($.isFunction(handler)) {
          this.onRowEvent('taphold', handler);
        } 
      },

      model: function (model) {
        var self = this,
            $ele = self.$ele;
        if ($.isArray(model) || $.isPlainObject(model)) {
          $ele.html('');
          self.idxs = [];
          
          if ($.isArray(model)) {
            self.modelData = model;
          } else if ($.type(self.repeat) === 'string' && $.isArray(model[self.repeat])) {
            self.modelData = model[self.repeat];
          } else {
            self.modelData = [model];
          }
          
          $.each(self.modelData, function (idx, data) {
            var template = replaceTemplate(self.templateHTML, data),
                $template = $(template),
                sn = getUniqueStamp();
            $template.attr('idx', sn).appendTo($ele).data('model', data);
            self.idxs.push(sn);
          });
          $ele.listview('refresh');
        } else {
          return self.modelData;
        }
      },

      addRow: function (data) {
        var self = this,
            $ele = self.$ele,
            template = replaceTemplate(self.templateHTML, data),
            $template = $(template),
            sn = getUniqueStamp();
        $template.attr('idx', sn).appendTo($ele).data('model', data);
        self.modelData.push(data);
        self.idxs.push(sn);
        $ele.listview('refresh');
      },
      
      insertRow: function (data, index) {
        (this.idxs.indexOf(index) > -1) && (index = this.idxs.indexOf(index));
        if (!$.isNumeric(index) || index >= this.idxs.length) {
          this.addRow(data);
        } else {
          var self = this,
              $ele = self.$ele,
              template = replaceTemplate(self.templateHTML, data),
              $template = $(template),
              sn = getUniqueStamp();
          $template.attr('idx', sn)
              .insertBefore($ele.find('[idx="' + self.idxs[index] + '"]:first'))
              .data('model', data);
          self.modelData.splice(index, 0, data);
          self.idxs.splice(index, 0, sn);
          $ele.listview('refresh');
        }
      },
      
      removeRow: function (index) {
        (this.idxs.indexOf(index) > -1) && (index = this.idxs.indexOf(index));
        if ($.isNumeric(index) && index < this.idxs.length) {
          var self = this,
              $ele = self.$ele;
          $ele.find('[idx="' + self.idxs[index] + '"]').remove();
          self.modelData.splice(index, 1);
          self.idxs.splice(index, 1);
          $ele.listview('refresh');          
        }
      }
      
    });
    
    function getUniqueStamp() {
      return new Date().getTime() + '' + Math.random();
    }

    function replaceTemplate(template, data) {
      for (var key in data) {
        if (data.hasOwnProperty(key)) {
          var regex = new RegExp('{{' + key + '}}|\\${' + key + '}', "g");
          template = template.replace(regex, data[key]);
        }
      }
      return template;
    }
    
    function dispatchEventToHandler (triggerEle, eo, handler, self) {
      if (typeof handler === 'function') {
        var $triggerEle = $(triggerEle),
            model = $triggerEle.data('model'),
            idx = self.idxs.indexOf($triggerEle.attr('idx'));
        handler.apply(triggerEle, [eo, model, idx]);
      }
    }
    
  </script>

</element>
