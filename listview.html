<script src='js/utils.js' var='utils'></script>

<element name='listview'>

  <template>
    <ul id="{{id}}" data-role="listview" repeat="{{repeat}}" style="{{style}}" data-autodividers="{{data-autodividers}}" data-divider-theme="{{data-divider-theme}}" data-filter-reveal="{{data-filter-reveal}}" data-filter="{{data-filter}}" data-filter-placeholder="{{data-filter-placeholder}}" data-filter-theme="{{data-filter-theme}}" data-icon="{{data-icon}}" data-inset="{{data-inset}}" data-split-icon="{{data-split-icon}}" data-split-theme="{{data-split-theme}}" data-theme="{{data-theme}}" data-count-theme="{{data-count-theme}}">
      <content></content>
    </ul>
  </template>

  <script>
  registerElement('listview', {

    init: function() {
      this.html = this.$ele.html().trim();
      if (typeof String.prototype.trim !== 'function') {
        String.prototype.trim = function() {
          return this.replace(/^\s+|\s+$/g, '');
        }
      }

      if (this.$originEle[0].tagName.toLowerCase() !== this.$ele.prop('tagName').toLowerCase()) {
        var $newEle = utils.replaceGKTagName(this.$originEle[0].tagName, this.$ele),
          attributes = this.$ele[0].attributes;
        $.each(attributes, function() {
          $newEle.attr(this.name, this.value);
        });
        $newEle.data('_gk_', this);
        this.$ele.replaceWith($newEle[0]);
        this.$ele = $newEle;
      }

      if (typeof this.$ele.attr('repeat') !== 'undefined') {
        this.$ele.html('');
      }
      this.templateHTML = this.$originEle.html();
      this.arrayModelName = this.$ele.attr('repeat');
      var self = this;
      this.$ele.on('click', function(e) {
        if (self.onSelectCallback) {
          self.onSelectCallback(self.$ele.find('li'));
        }
      });
      this.onSelectCallback = function() {};
    },

    refresh: function() {
      this.$ele.listview('refresh');
    },

    onRow: function(callback) {
      this.onSelectCallback = callback;
    },

    model: function(model) {
      var self = this;
      self.$ele.listview({
        autodividersSelector: function(li) {
          return self.$ele.attr('autodividers') === 'undefined' ?
            null : li.attr('divider');
        }
      });
      var iterator = typeof self.arrayModelName == 'undefined' ?
        model : model[self.arrayModelName];
      self.$ele.html('');
      $(iterator).each(function(idx, obj) {
        var newOne = self.templateHTML;
        for (var key in obj) {
          var regex = new RegExp('\\${' + key + '}', "g");
          newOne = newOne.replace(regex, obj[key]);
        }
        self.$ele.append(newOne);
      });
      self.$ele.listview('refresh');
    },

    apply: function(info) {
      var self = this,
        html = self.html;
      for (var property in info) {
        if (info.hasOwnProperty(property)) {
          var regex = new RegExp('\\${' + property + '}', "gi");
          html = html.replace(regex, info[property]);
        }
      }
      var $html = $('<div>' + html + '</div>');
      $html.find('[data-readonly=Y]').each(function(idx, node) {
        $(node).replaceWith($(node).html());
      });
      self.$ele.html($html.html());
      self.$ele.listview("refresh", true);
    }

  });
  </script>

</element>
